<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ›æ„æ¶‚é¸¦æ¿</title>
    <style>
        :root {
            --bg-color: #f0f3f8;
            --panel-color: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            /* ç¦æ­¢é¡µé¢æ»šåŠ¨ */
            touch-action: none;
            /* ç¦æ­¢ç³»ç»Ÿé»˜è®¤çš„æ‰‹åŠ¿ */
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #8A7BFF;
            color: white;
            z-index: 10;
        }

        .back-btn,
        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-group {
            display: flex;
            gap: 10px;
        }

        /* ç”»å¸ƒåŒºåŸŸ */
        #canvas-container {
            flex: 1;
            position: relative;
            background: white;
            cursor: crosshair;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        canvas {
            display: block;
            touch-action: none;
        }

        /* åº•éƒ¨å·¥å…·æ  */
        .toolbar {
            padding: 15px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-options {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .color-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, border-color 0.2s;
            flex-shrink: 0;
        }

        .color-btn.active {
            transform: scale(1.1);
            border-color: #333;
        }

        /* æ©¡çš®æ“¦å’Œç²—ç»†æ§åˆ¶ */
        .tool-btn {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            border: none;
            background: #f0f0f0;
            font-size: 24px;
            cursor: pointer;
        }

        .tool-btn.active {
            background: #8A7BFF;
            color: white;
        }
    </style>
</head>

<body>

    <div class="header">
        <button class="back-btn" onclick="history.back()">ğŸ </button>
        <span style="font-weight: bold; font-size: 1.1rem;">å°å°ç”»å®¶</span>
        <div class="action-group">
            <button class="action-btn" onclick="clearCanvas()" title="æ¸…ç©º">ğŸ—‘ï¸</button>
            <button class="action-btn" onclick="saveImage()" title="ä¿å­˜">ğŸ“·</button>
        </div>
    </div>

    <div id="canvas-container">
        <canvas id="drawing-board"></canvas>
    </div>

    <div class="toolbar">
        <!-- æ©¡çš®æ“¦ -->
        <button class="tool-btn" id="eraser" onclick="setEraser()">ğŸ§½</button>

        <!-- é¢œè‰²æ¡ -->
        <div class="color-options" id="color-palette">
            <!-- JS åŠ¨æ€ç”Ÿæˆé¢œè‰² -->
        </div>
    </div>

    <script>
        // --- 1. è¯­éŸ³æ¨¡å— (å¤ç”¨ä¹‹å‰çš„é€»è¾‘) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;

        function loadVoices() {
            const allVoices = synth.getVoices();
            let mandarinVoices = allVoices.filter(v => v.lang.replace('_', '-').toLowerCase() === 'zh-cn');
            if (mandarinVoices.length === 0) mandarinVoices = allVoices.filter(v => v.lang.includes('zh'));

            preferredVoice = mandarinVoices.find(v => v.name.includes('Google') && v.name.includes('Chinese')) ||
                mandarinVoices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural')) ||
                mandarinVoices.find(v => v.name.includes('Ting-Ting')) ||
                mandarinVoices[0];
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            if (preferredVoice) utterThis.voice = preferredVoice;
            utterThis.pitch = 1.1;
            utterThis.rate = 1.0;
            synth.speak(utterThis);
        }

        // --- 2. ç”»å¸ƒè®¾ç½® ---
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');

        // é¢œè‰²é…ç½®
        const colors = [
            { code: '#FF0000', name: 'çº¢è‰²' },
            { code: '#FFA500', name: 'æ©™è‰²' },
            { code: '#FFFF00', name: 'é»„è‰²' },
            { code: '#008000', name: 'ç»¿è‰²' },
            { code: '#00BFFF', name: 'è“è‰²' },
            { code: '#800080', name: 'ç´«è‰²' },
            { code: '#FFC0CB', name: 'ç²‰è‰²' },
            { code: '#000000', name: 'é»‘è‰²' },
            { code: '#8B4513', name: 'æ£•è‰²' }
        ];

        let painting = false;
        let brushSize = 10; // é»˜è®¤ç¬”è§¦å¤§å°ï¼Œé€‚åˆå°å­©
        let currentColor = '#FF0000';
        let isEraser = false;

        // åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸ (å¤„ç†é«˜æ¸…å±æ¨¡ç³Šé—®é¢˜)
        function resizeCanvas() {
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            // è®¾ç½®ç”»å¸ƒçš„æ˜¾ç¤ºå°ºå¯¸
            canvas.style.width = width + "px";
            canvas.style.height = height + "px";

            // è®¾ç½®ç”»å¸ƒçš„å®é™…åƒç´ å°ºå¯¸ (Retinaå±ä¼˜åŒ–)
            const scale = window.devicePixelRatio || 1;
            canvas.width = width * scale;
            canvas.height = height * scale;

            ctx.scale(scale, scale);

            // æ¯æ¬¡é‡ç½®å°ºå¯¸åï¼Œéœ€è¦é‡æ–°è®¾ç½®ç”»ç¬”æ ·å¼
            updateBrushStyle();
        }

        function updateBrushStyle() {
            ctx.lineCap = 'round'; // åœ†å¤´ç¬”è§¦
            ctx.lineJoin = 'round'; // è½¬è§’åœ†æ»‘
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = isEraser ? '#ffffff' : currentColor;
        }

        window.addEventListener('resize', resizeCanvas);
        // åˆå§‹å»¶è¿Ÿè°ƒç”¨ï¼Œç¡®ä¿å¸ƒå±€åŠ è½½å®Œæ¯•
        setTimeout(resizeCanvas, 100);

        // --- 3. ç»˜ç”»é€»è¾‘ (åŒæ—¶æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸) ---
        function startPosition(e) {
            painting = true;
            draw(e); // ç‚¹å‡»å³ç”»ä¸€ä¸ªç‚¹
        }

        function endPosition() {
            painting = false;
            ctx.beginPath(); // ç»“æŸè·¯å¾„ï¼Œé˜²æ­¢è¿çº¿
        }

        function draw(e) {
            if (!painting) return;

            // è·å–åæ ‡
            let clientX, clientY;
            if (e.type.includes('touch')) {
                // è§¦æ‘¸äº‹ä»¶
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                // é¼ æ ‡äº‹ä»¶
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // è½¬æ¢ç›¸å¯¹åæ ‡
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        // äº‹ä»¶ç›‘å¬
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseleave', endPosition); // ç§»å‡ºç”»å¸ƒåœæ­¢

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ç¦æ­¢æ»šåŠ¨
            startPosition(e);
        }, { passive: false });

        canvas.addEventListener('touchend', endPosition);
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // ç¦æ­¢æ»šåŠ¨
            draw(e);
        }, { passive: false });

        // --- 4. å·¥å…·æ é€»è¾‘ ---

        // åˆå§‹åŒ–é¢œè‰²ç›˜
        const palette = document.getElementById('color-palette');
        colors.forEach((c, index) => {
            const btn = document.createElement('div');
            btn.className = 'color-btn';
            btn.style.backgroundColor = c.code;
            if (index === 0) btn.classList.add('active'); // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª

            btn.onclick = () => {
                selectColor(c.code, c.name, btn);
            };
            palette.appendChild(btn);
        });

        function selectColor(color, name, btn) {
            isEraser = false;
            currentColor = color;
            updateBrushStyle();
            speak(name); // æ’­æ”¾è¯­éŸ³ï¼šâ€œçº¢è‰²â€

            // UI æ›´æ–°
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('eraser').classList.remove('active');
        }

        function setEraser() {
            isEraser = true;
            updateBrushStyle();
            speak("æ©¡çš®æ“¦");

            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('eraser').classList.add('active');
        }

        function clearCanvas() {
            // è¿™é‡Œçš„ canvas.width/scale æ˜¯å› ä¸ºæˆ‘ä»¬ä¸Šé¢åšäº† Retina ç¼©æ”¾
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            speak("é‡æ–°ç”»");
        }

        function saveImage() {
            speak("ä¿å­˜å¥½å•¦");
            // åˆ›å»ºä¸€ä¸ªç™½è‰²èƒŒæ™¯çš„ä¸´æ—¶ Canvas (é˜²æ­¢é€æ˜èƒŒæ™¯å­˜æˆé»‘è‰²)
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            // æŠŠç”»çš„å†…å®¹ç›–ä¸Šå»
            tempCtx.drawImage(canvas, 0, 0);

            // ä¸‹è½½
            const link = document.createElement('a');
            link.download = 'æˆ‘çš„ç”»ä½œ-' + Date.now() + '.png';
            link.href = tempCanvas.toDataURL();
            link.click();
        }
    </script>
</body>

</html>