<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾æŒ‘æˆ˜</title>
    <style>
        :root {
            --bg-color: #A5D6A7;
            /* æŸ”å’Œçš„ç»¿è‰²èƒŒæ™¯ */
            --panel-color: #ffffff;
            --primary-color: #4CAF50;
        }

        body {
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background-color: var(--bg-color);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2E7D32;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.5);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }

        .level-badge {
            background: rgba(255, 255, 255, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        /* ç›®æ ‡æç¤ºå›¾ (å°å›¾) */
        .preview-box {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .preview-label {
            position: absolute;
            bottom: -25px;
            font-size: 1rem;
            color: #1B5E20;
            font-weight: bold;
        }

        .preview-img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            font-size: 60px;
            /* å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºEmoji */
            text-align: center;
            line-height: 80px;
        }

        /* æ‹¼å›¾åŒºåŸŸ */
        .puzzle-board {
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 5px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 2x2 ç½‘æ ¼ */
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .puzzle-piece {
            background-size: 300px 300px;
            /* å…³é”®ï¼šèƒŒæ™¯å›¾å°ºå¯¸ç­‰äºæ‹¼å›¾æ€»å°ºå¯¸ */
            background-repeat: no-repeat;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            background-color: white;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .puzzle-piece.selected {
            border: 3px solid #FF5252;
            transform: scale(0.95);
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.6);
            z-index: 10;
        }

        /* æˆåŠŸè¿‡å…³åçš„é®ç½© */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            display: none;
            /* é»˜è®¤éšè— */
            animation: fadeIn 0.5s;
        }

        .success-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .next-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 5px 0 #2E7D32;
        }

        .next-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* éšè—çš„Canvasï¼Œç”¨äºç”Ÿæˆå›¾ç‰‡ */
        #generator-canvas {
            display: none;
        }
    </style>
</head>

<body>

    <div class="header">
        <button class="back-btn" onclick="history.back()">ğŸ </button>
        <div class="level-badge" id="level-display">ç¬¬ 1 å…³</div>
    </div>

    <div class="game-container">
        <!-- é¢„è§ˆå›¾ -->
        <div class="preview-box">
            <img id="preview-img" class="preview-img" src="" alt="ç›®æ ‡">
            <span class="preview-label" id="target-name">...</span>
        </div>

        <!-- æ‹¼å›¾æ“ä½œåŒº -->
        <div class="puzzle-board" id="board">
            <!-- åŠ¨æ€ç”Ÿæˆ 4 ä¸ªæ–¹å— -->
        </div>

        <p style="color: #1B5E20; opacity: 0.8; font-size: 0.9rem;">
            ğŸ‘† ç‚¹å‡»ä¸¤å—æ‹¼å›¾äº¤æ¢ä½ç½®
        </p>
    </div>

    <!-- è¿‡å…³å¼¹çª— -->
    <div class="overlay" id="success-overlay">
        <div class="success-card">
            <div style="font-size: 60px;">ğŸ‰</div>
            <h2 style="color:#2E7D32; margin:10px 0;">æ‹¼å¥½å•¦ï¼</h2>
            <button class="next-btn" onclick="nextLevel()">ä¸‹ä¸€å…³ â¡ï¸</button>
        </div>
    </div>

    <!-- ç”¨äºç»˜å›¾çš„ç”»å¸ƒ -->
    <canvas id="generator-canvas" width="300" height="300"></canvas>

    <script>
        // --- 1. å…³å¡æ•°æ® (36ä¸ªå…³å¡ï¼ŒEmoji + èƒŒæ™¯è‰² + ä¸­æ–‡å) ---
        const levels = [
            { icon: 'ğŸ¦', color: '#FFE082', name: 'ç‹®å­' },
            { icon: 'ğŸš—', color: '#90CAF9', name: 'å°æ±½è½¦' },
            { icon: 'ğŸš€', color: '#B39DDB', name: 'ç«ç®­' },
            { icon: 'ğŸ‚', color: '#F48FB1', name: 'è›‹ç³•' },
            { icon: 'ğŸ˜', color: '#CFD8DC', name: 'å¤§è±¡' },
            { icon: 'ğŸ¦–', color: '#A5D6A7', name: 'æé¾™' },
            { icon: 'ğŸš‘', color: '#FFCCBC', name: 'æ•‘æŠ¤è½¦' },
            { icon: 'ğŸ°', color: '#FFF59D', name: 'åŸå ¡' },
            { icon: 'ğŸ¶', color: '#D7CCC8', name: 'å°ç‹—' },
            { icon: 'ğŸ±', color: '#FFE0B2', name: 'å°çŒ«' },
            { icon: 'ğŸ¢', color: '#C8E6C9', name: 'ä¹Œé¾Ÿ' },
            { icon: 'ğŸš’', color: '#FFAB91', name: 'æ¶ˆé˜²è½¦' },
            { icon: 'ğŸš', color: '#81D4FA', name: 'ç›´å‡æœº' },
            { icon: 'ğŸ¼', color: '#E0E0E0', name: 'ç†ŠçŒ«' },
            { icon: 'ğŸ¦„', color: '#E1BEE7', name: 'ç‹¬è§’å…½' },
            { icon: 'â›„', color: '#B2EBF2', name: 'é›ªäºº' },
            { icon: 'ğŸŸ', color: '#FFD54F', name: 'è–¯æ¡' },
            { icon: 'ğŸ©', color: '#F8BBD0', name: 'ç”œç”œåœˆ' },
            { icon: 'ğŸš‚', color: '#B0BEC5', name: 'ç«è½¦' },
            { icon: 'âš½', color: '#BDBDBD', name: 'è¶³çƒ' },
            { icon: 'ğŸš²', color: '#A1887F', name: 'è‡ªè¡Œè½¦' },
            { icon: 'â°', color: '#FFAB40', name: 'é—¹é’Ÿ' },
            { icon: 'ğŸ', color: '#EF9A9A', name: 'ç¤¼ç‰©' },
            { icon: 'ğŸŒ»', color: '#FFF176', name: 'å‘æ—¥è‘µ' },
            { icon: 'ğŸ¦', color: '#80DEEA', name: 'å†°æ·‡æ·‹' },
            { icon: 'ğŸ³', color: '#64B5F6', name: 'é²¸é±¼' },
            { icon: 'ğŸ¦‹', color: '#CE93D8', name: 'è´è¶' },
            { icon: 'ğŸ ', color: '#DACE25', name: 'æˆ¿å­' },
            { icon: 'ğŸ‘‘', color: '#FFD740', name: 'çš‡å† ' },
            { icon: 'ğŸ¸', color: '#FF8A65', name: 'å‰ä»–' },
            { icon: 'ğŸ§¸', color: '#BCAAA4', name: 'ç©å…·ç†Š' },
            { icon: 'ğŸ¡', color: '#9FA8DA', name: 'æ‘©å¤©è½®' },
            { icon: 'ğŸ”', color: '#FFCC80', name: 'æ±‰å ¡åŒ…' },
            { icon: 'ğŸ•', color: '#FFAB91', name: 'æŠ«è¨' },
            { icon: 'ğŸ¤–', color: '#90A4AE', name: 'æœºå™¨äºº' },
            { icon: 'ğŸ‘½', color: '#C5E1A5', name: 'å¤–æ˜Ÿäºº' }
        ];

        // --- 2. è¯­éŸ³æ¨¡å— (å¼ºåˆ¶æ™®é€šè¯) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;

        function loadVoices() {
            const allVoices = synth.getVoices();
            let mandarinVoices = allVoices.filter(v => v.lang.replace('_', '-').toLowerCase() === 'zh-cn');
            if (mandarinVoices.length === 0) mandarinVoices = allVoices.filter(v => v.lang.includes('zh'));
            preferredVoice = mandarinVoices.find(v => v.name.includes('Google') && v.name.includes('Chinese')) ||
                mandarinVoices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural')) ||
                mandarinVoices.find(v => v.name.includes('Ting-Ting')) ||
                mandarinVoices[0];
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            if (preferredVoice) utterThis.voice = preferredVoice;
            utterThis.pitch = 1.1; utterThis.rate = 1.0;
            synth.speak(utterThis);
        }

        // --- 3. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---
        let currentLevelIndex = 0;
        let selectedPiece = null;
        let isAnimating = false;
        let generatedImageUrl = '';

        const board = document.getElementById('board');
        const canvas = document.getElementById('generator-canvas');
        const ctx = canvas.getContext('2d');

        // ç”Ÿæˆå›¾ç‰‡å¹¶å¯åŠ¨å…³å¡
        function initLevel(index) {
            document.getElementById('success-overlay').style.display = 'none';
            document.getElementById('level-display').innerText = `ç¬¬ ${index + 1} å…³`;

            // å¾ªç¯ç©
            const levelData = levels[index % levels.length];

            document.getElementById('target-name').innerText = levelData.name;

            // 1. åœ¨ Canvas ä¸Šç»˜åˆ¶ Emoji å›¾ç‰‡
            ctx.fillStyle = levelData.color;
            ctx.fillRect(0, 0, 300, 300); // èƒŒæ™¯

            // å¢åŠ ä¸€äº›è£…é¥°åœ†ç‚¹ï¼Œè®©æ‹¼å›¾æ›´æœ‰çº¹ç†ï¼Œæ–¹ä¾¿è¾¨è®¤æ–¹å‘
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath(); ctx.arc(30, 30, 10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(270, 270, 20, 0, Math.PI * 2); ctx.fill();

            // ç»˜åˆ¶ Emoji
            ctx.font = "180px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(levelData.icon, 150, 160);

            // å¯¼å‡ºä¸ºå›¾ç‰‡ URL
            generatedImageUrl = canvas.toDataURL("image/png");
            document.getElementById('preview-img').src = generatedImageUrl;

            speak(`æ‹¼ä¸€ä¸ª${levelData.name}`);

            // 2. åˆ›å»ºæ‹¼å›¾å—
            createPuzzlePieces();
        }

        function createPuzzlePieces() {
            board.innerHTML = '';
            selectedPiece = null;

            // 2x2 ç½‘æ ¼ï¼Œæ ‡å‡†ä½ç½®æ˜¯ 0,1,2,3
            // 0: å·¦ä¸Š, 1: å³ä¸Š, 2: å·¦ä¸‹, 3: å³ä¸‹
            let pieces = [0, 1, 2, 3];

            // éšæœºæ‰“ä¹±ï¼Œç›´åˆ°å®ƒä¸æ˜¯åŸå§‹é¡ºåº
            do {
                pieces.sort(() => Math.random() - 0.5);
            } while (isSolved(pieces));

            // æ¸²æŸ“æ–¹å—
            pieces.forEach((posIndex, domIndex) => {
                const div = document.createElement('div');
                div.className = 'puzzle-piece';
                div.style.backgroundImage = `url(${generatedImageUrl})`;

                // è®¡ç®—èƒŒæ™¯åç§»é‡ (åˆ‡å‰²å›¾ç‰‡)
                // posIndex æ˜¯è¿™å—å›¾æœ¬æ¥åº”è¯¥åœ¨çš„ä½ç½®
                // 0 (0,0) | 1 (-150, 0)
                // 2 (0,-150)| 3 (-150, -150)
                const bgX = (posIndex % 2) * -150;
                const bgY = Math.floor(posIndex / 2) * -150;
                div.style.backgroundPosition = `${bgX}px ${bgY}px`;

                // è®°å½•è¿™å—å›¾çš„çœŸå®ID
                div.dataset.id = posIndex;

                // ç‚¹å‡»äº‹ä»¶
                div.onclick = () => handlePieceClick(div);

                board.appendChild(div);
            });
        }

        // æ£€æŸ¥æ˜¯å¦æ‹¼å¥½äº†
        function isSolved(currentArr) {
            // å¦‚æœä¼ å…¥äº†æ•°ç»„ï¼Œæ£€æŸ¥æ•°ç»„ï¼›å¦åˆ™æ£€æŸ¥ DOM
            if (currentArr) {
                return currentArr[0] === 0 && currentArr[1] === 1 && currentArr[2] === 2 && currentArr[3] === 3;
            }

            const nodes = board.children;
            for (let i = 0; i < 4; i++) {
                if (parseInt(nodes[i].dataset.id) !== i) return false;
            }
            return true;
        }

        // ç‚¹å‡»äº¤äº’é€»è¾‘ (äº’æ¢æ¨¡å¼)
        function handlePieceClick(clickedElement) {
            if (isAnimating) return;

            // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
            playClickSound();

            if (!selectedPiece) {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šé€‰ä¸­
                selectedPiece = clickedElement;
                clickedElement.classList.add('selected');
            } else {
                // ç¬¬äºŒæ¬¡ç‚¹å‡»
                if (selectedPiece === clickedElement) {
                    // ç‚¹äº†è‡ªå·±ï¼šå–æ¶ˆé€‰ä¸­
                    selectedPiece.classList.remove('selected');
                    selectedPiece = null;
                } else {
                    // ç‚¹äº†åˆ«äººï¼šäº¤æ¢ï¼
                    swapElements(selectedPiece, clickedElement);
                    selectedPiece.classList.remove('selected');
                    selectedPiece = null;
                }
            }
        }

        function swapElements(el1, el2) {
            isAnimating = true;

            // è§†è§‰ä¸Šäº¤æ¢å†…å®¹ (å› ä¸º grid å¸ƒå±€ç”± DOM é¡ºåºå†³å®šï¼Œæˆ‘ä»¬åªéœ€äº¤æ¢ DOM èŠ‚ç‚¹)
            // ä¸ºäº†æœ‰åŠ¨ç”»æ•ˆæœï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥äº¤æ¢ DOM
            // å¦‚æœè¦åšæ»‘å—åŠ¨ç”»æ¯”è¾ƒå¤æ‚ï¼Œå¯¹äº3å²å­©å­ï¼Œç›´æ¥å˜è¿‡å»ä¹Ÿå¯ä»¥æ¥å—

            const parent = board;
            const temp = document.createElement("div"); // å ä½ç¬¦

            parent.insertBefore(temp, el1);
            parent.insertBefore(el1, el2);
            parent.insertBefore(el2, temp);
            parent.removeChild(temp);

            speak("å˜ï¼"); // äº¤äº’éŸ³æ•ˆ

            setTimeout(() => {
                isAnimating = false;
                if (isSolved()) {
                    handleWin();
                }
            }, 300);
        }

        function handleWin() {
            playWinSound();
            speak("å“‡ï¼æ‹¼å¯¹å•¦ï¼ä½ çœŸæ£’ï¼");
            document.getElementById('success-overlay').style.display = 'flex';
            fireConfetti();
        }

        function nextLevel() {
            currentLevelIndex++;
            initLevel(currentLevelIndex);
        }

        // ç®€å•çš„éŸ³æ•ˆ
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playClickSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function playWinSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            // ç®€å•çš„ç¶éŸ³
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            osc.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
            osc.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5

            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6);

            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.6);
        }

        // çƒŸèŠ±
        function fireConfetti() {
            for (let i = 0; i < 50; i++) {
                const c = document.createElement('div');
                c.innerText = ['ğŸ‰', 'â­', 'âœ¨'][Math.floor(Math.random() * 3)];
                c.style.position = 'fixed';
                c.style.left = '50%'; c.style.top = '50%';
                c.style.fontSize = Math.random() * 20 + 20 + 'px';
                c.style.transition = 'all 1s ease-out';
                c.style.zIndex = '200';
                document.body.appendChild(c);
                requestAnimationFrame(() => {
                    c.style.transform = `translate(${(Math.random() - 0.5) * window.innerWidth}px, ${(Math.random() - 0.5) * window.innerHeight}px) rotate(${Math.random() * 360}deg)`;
                    c.style.opacity = 0;
                });
                setTimeout(() => c.remove(), 1000);
            }
        }

        // å¯åŠ¨
        initLevel(0);

    </script>
</body>

</html>