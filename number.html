<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°å­¦å°å¤©æ‰ - æ•°ä¸€æ•°</title>
    <style>
        :root {
            --primary-color: #8A7BFF;
            /* ä½ æˆªå›¾é‡Œçš„ç´«è‰² */
            --bg-color: #C6C0FF;
            /* æµ…ç´«è‰²èƒŒæ™¯ */
            --white: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* é¡¶éƒ¨å¯¼èˆªåŒº */
        .header {
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            color: white;
        }

        /* æ¸¸æˆä¸»æ˜¾ç¤ºåŒº */
        .game-board {
            flex: 1;
            width: 90%;
            background: var(--white);
            margin: 10px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 15px;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* æ˜¾ç¤ºçš„ç‰©ä½“ï¼ˆEmojiï¼‰ */
        .game-item {
            font-size: 60px;
            /* å¤§å›¾æ ‡ */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* åº•éƒ¨ç­”æ¡ˆåŒº */
        .options-container {
            width: 100%;
            padding: 20px;
            padding-bottom: max(60px, calc(60px + env(safe-area-inset-bottom)));
            /* é€‚é…æ‰‹æœºåº•éƒ¨ */
            display: flex;
            justify-content: center;
            gap: 20px;
            box-sizing: border-box;
        }

        .option-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background-color: var(--white);
            color: var(--primary-color);
            font-size: 36px;
            font-weight: bold;
            box-shadow: 0 6px 0 #ddd;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .option-btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        /* ç­”å¯¹çš„æ•ˆæœ */
        .option-btn.correct {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 6px 0 #2E7D32;
        }

        /* ç­”é”™çš„æ•ˆæœ */
        .option-btn.wrong {
            background-color: #FF5252;
            color: white;
            animation: shake 0.4s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        /* ç®€å•çš„çƒŸèŠ±ç²’å­å®¹å™¨ */
        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
    </style>
</head>

<body>

    <div class="header">
        <button class="back-btn" onclick="history.back()">ğŸ </button>
        <span style="color:white; font-size: 1.2rem; font-weight:bold">æ•°ä¸€æ•°</span>
        <div style="width:40px"></div> <!-- å ä½ä¿æŒå¹³è¡¡ -->
    </div>

    <div class="game-board" id="board">
        <!-- è¿™é‡Œä¼šåŠ¨æ€ç”Ÿæˆè‹¹æœã€è½¦è½¦ç­‰ -->
    </div>

    <div class="options-container" id="options">
        <!-- ç­”æ¡ˆæŒ‰é’®åœ¨è¿™é‡Œ -->
    </div>

    <canvas id="confetti-canvas"></canvas>
    <script>
        // --- 1. æ¸¸æˆç´ æé…ç½® ---
        const items = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ¶', 'ğŸ±', 'ğŸš—', 'â­', 'ğŸˆ', 'ğŸ¦Š', 'ğŸ¼'];
        let currentNumber = 0;
        let isProcessing = false;

        // --- 2. è¯­éŸ³åˆæˆæ¨¡å— (å¼ºåˆ¶æ™®é€šè¯ç‰ˆ) ---
        const synth = window.speechSynthesis;
        let preferredVoice = null;

        // è·å–å¹¶ç­›é€‰æœ€ä½³å£°éŸ³
        function loadVoices() {
            const allVoices = synth.getVoices();

            // ã€å…³é”®æ­¥éª¤ã€‘ä¸¥æ ¼ç­›é€‰ lang å±æ€§åŒ…å« 'zh-CN' çš„å£°éŸ³
            // è¿™èƒ½æ’é™¤å¹¿ä¸œè¯ (zh-HK) å’Œ å°æ¹¾æ™®é€šè¯ (zh-TW)
            let mandarinVoices = allVoices.filter(voice =>
                voice.lang.replace('_', '-').toLowerCase() === 'zh-cn'
            );

            // å¦‚æœæ‰¾ä¸åˆ°ä¸¥æ ¼çš„ zh-CNï¼Œå°è¯•æ‰¾ä»»æ„åŒ…å« zh çš„ï¼ˆä½œä¸ºå…œåº•ï¼Œä½†å¤§æ¦‚ç‡ä¸éœ€è¦ï¼‰
            if (mandarinVoices.length === 0) {
                mandarinVoices = allVoices.filter(voice => voice.lang.includes('zh'));
            }

            if (mandarinVoices.length === 0) {
                console.log("æœªæ‰¾åˆ°ä¸­æ–‡è¯­éŸ³åŒ…ï¼Œå°†ä½¿ç”¨é»˜è®¤å£°éŸ³");
                return;
            }

            // ã€ä¼˜å…ˆçº§æ’åºã€‘
            // 1. Google æ™®é€šè¯ (Android/Chrome ä½“éªŒæä½³)
            // 2. å¾®è½¯ Natural (Windows Edge æä½³)
            // 3. è‹¹æœ Ting-Ting (iOS ç»å…¸ä¸­æ–‡å£°)
            preferredVoice = mandarinVoices.find(v => v.name.includes('Google') && v.name.includes('Chinese')) ||
                mandarinVoices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural')) ||
                mandarinVoices.find(v => v.name.includes('Ting-Ting')) ||
                mandarinVoices.find(v => v.name.includes('Ping-Fang')) ||
                mandarinVoices[0]; // å®åœ¨æ²¡æœ‰å°±ç”¨åˆ—è¡¨é‡Œç¬¬ä¸€ä¸ªæ™®é€šè¯

            console.log("å·²é”å®šæ™®é€šè¯è¯­éŸ³:", preferredVoice.name);
        }

        // ç›‘å¬è¯­éŸ³åº“åŠ è½½ (è§£å†³éƒ¨åˆ†æµè§ˆå™¨å¼‚æ­¥åŠ è½½é—®é¢˜)
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function speak(text) {
            if (synth.speaking) synth.cancel(); // æ‰“æ–­ä¸Šä¸€å¥

            const utterThis = new SpeechSynthesisUtterance(text);

            // ã€å¼ºåˆ¶è®¾å®šè¯­è¨€ã€‘
            utterThis.lang = 'zh-CN';

            // å¦‚æœæ‰¾åˆ°äº†é€‰å®šçš„æ™®é€šè¯å£°éŸ³ï¼Œå°±åº”ç”¨å®ƒ
            if (preferredVoice) {
                utterThis.voice = preferredVoice;
            }

            // ã€å‚æ•°å¾®è°ƒã€‘é€‚åˆå„¿ç«¥çš„è¯­è°ƒ
            utterThis.pitch = 1.1; // ç¨å¾®é«˜æ˜‚ä¸€ç‚¹ï¼Œæ¯”è¾ƒæœ‰æ´»åŠ›
            utterThis.rate = 0.9; // è¯­é€Ÿæ”¾æ…¢ï¼Œè®©å­©å­å¬æ¸…æ¥š
            utterThis.volume = 1;

            synth.speak(utterThis);
        }

        // --- 3. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ---

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            isProcessing = false;
            const board = document.getElementById('board');
            const optionsDiv = document.getElementById('options');

            board.innerHTML = '';
            optionsDiv.innerHTML = '';

            // éš¾åº¦ï¼šéšæœº 1-5 ä¸ª
            currentNumber = Math.floor(Math.random() * 5) + 1;

            // éšæœºç‰©å“
            const randomItem = items[Math.floor(Math.random() * items.length)];

            // æ¸²æŸ“ç‰©å“åˆ°å±å¹•
            for (let i = 0; i < currentNumber; i++) {
                const span = document.createElement('span');
                span.className = 'game-item';
                span.textContent = randomItem;
                span.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                board.appendChild(span);
            }

            // æ’­æŠ¥é¢˜ç›® (å»¶è¿Ÿ300msç¡®ä¿é¡µé¢æ¸²æŸ“å®Œ)
            setTimeout(() => {
                speak(`æ•°ä¸€æ•°ï¼Œæœ‰å‡ ä¸ª${getEmojiName(randomItem)}ï¼Ÿ`);
            }, 300);

            // ç”Ÿæˆç­”æ¡ˆé€‰é¡¹ (1çœŸ2å‡)
            let answers = [currentNumber];
            while (answers.length < 3) {
                let wrong = Math.floor(Math.random() * 5) + 1;
                if (!answers.includes(wrong)) answers.push(wrong);
            }
            answers.sort(() => Math.random() - 0.5); // æ‰“ä¹±é¡ºåº

            // æ¸²æŸ“åº•éƒ¨æŒ‰é’®
            answers.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = num;
                btn.onclick = () => checkAnswer(num, btn);
                optionsDiv.appendChild(btn);
            });
        }

        // ç‰©å“ä¸­æ–‡åæ˜ å°„
        function getEmojiName(emoji) {
            const map = {
                'ğŸ': 'è‹¹æœ', 'ğŸŒ': 'é¦™è•‰', 'ğŸ‡': 'è‘¡è„',
                'ğŸ¶': 'å°ç‹—', 'ğŸ±': 'å°çŒ«', 'ğŸš—': 'å°æ±½è½¦',
                'â­': 'æ˜Ÿæ˜Ÿ', 'ğŸˆ': 'æ°”çƒ', 'ğŸ¦Š': 'ç‹ç‹¸', 'ğŸ¼': 'ç†ŠçŒ«'
            };
            return map[emoji] || 'ä¸œè¥¿';
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(selectedNum, btnElement) {
            if (isProcessing) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

            if (selectedNum === currentNumber) {
                // ç­”å¯¹é€»è¾‘
                isProcessing = true;
                btnElement.classList.add('correct');

                const praises = ["ç­”å¯¹äº†ï¼çœŸæ£’ï¼", "å“‡ï¼ä½ å¥½èªæ˜ï¼", "å®Œå…¨æ­£ç¡®ï¼"];
                const randomPraise = praises[Math.floor(Math.random() * praises.length)];
                speak(randomPraise);

                fireConfetti(); // æ”¾çƒŸèŠ±

                // 2ç§’åè¿›å…¥ä¸‹ä¸€å…³
                setTimeout(() => {
                    initGame();
                }, 2000);
            } else {
                // ç­”é”™é€»è¾‘
                btnElement.classList.add('wrong');
                speak("ä¸å¯¹å“¦ï¼Œå†è¯•ä¸€æ¬¡"); // ç®€å•ç›´æ¥çš„é¼“åŠ±
                if (navigator.vibrate) navigator.vibrate(200); // æ‰‹æœºéœ‡åŠ¨

                setTimeout(() => {
                    btnElement.classList.remove('wrong');
                }, 500);
            }
        }

        // çƒŸèŠ±ç‰¹æ•ˆ (çº¯JSå®ç°ï¼Œæ— éœ€Canvasåº“)
        function fireConfetti() {
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.innerText = ['ğŸ‰', 'âœ¨', 'ğŸŒŸ'][Math.floor(Math.random() * 3)];
                confetti.style.position = 'absolute';
                confetti.style.left = '50%';
                confetti.style.top = '50%';
                confetti.style.fontSize = Math.random() * 20 + 10 + 'px';
                confetti.style.transition = 'all 1s ease-out';
                confetti.style.zIndex = 1000;
                confetti.style.pointerEvents = 'none';
                document.body.appendChild(confetti);

                requestAnimationFrame(() => {
                    const destX = (Math.random() - 0.5) * window.innerWidth;
                    const destY = (Math.random() - 0.5) * window.innerHeight;
                    confetti.style.transform = `translate(${destX}px, ${destY}px) rotate(${Math.random() * 360}deg)`;
                    confetti.style.opacity = 0;
                });
                setTimeout(() => confetti.remove(), 1000);
            }
        }

        // å¯åŠ¨æ¸¸æˆ
        initGame();
    </script>
</body>

</html>