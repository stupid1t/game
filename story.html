<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="./manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•…äº‹ç‹å›½ - æ²‰æµ¸å¼3Dç»˜æœ¬</title>
    <!-- å¼•å…¥ Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a2e;
            font-family: 'Segoe UI', sans-serif;
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* è®©ç‚¹å‡»ç©¿é€åˆ° Canvas */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .header {
            padding: 15px;
            display: flex;
            align-items: center;
            pointer-events: auto;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* æ•…äº‹æ–‡æœ¬æ˜¾ç¤ºåŒº */
        .story-text-box {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2rem;
            line-height: 1.6;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s;
            pointer-events: auto;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        }

        .ctrl-btn {
            background: #8A7BFF;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(138, 123, 255, 0.4);
            cursor: pointer;
        }

        /* æ•…äº‹åˆ—è¡¨æŠ½å±‰ */
        #story-list {
            position: absolute;
            top: 60px;
            right: -300px;
            /* é»˜è®¤éšè— */
            width: 250px;
            height: 70%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px 0 0 20px;
            overflow-y: auto;
            transition: right 0.3s;
            pointer-events: auto;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }

        #story-list.open {
            right: 0;
        }

        .story-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .story-item:hover {
            background: #f0f0ff;
        }

        .story-item.active {
            background: #8A7BFF;
            color: white;
        }

        #list-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body>

    <!-- 3D æ¸²æŸ“å®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        <div class="header">
            <button class="back-btn" onclick="history.back()">ğŸ </button>
            <button id="list-toggle" onclick="toggleList()">ğŸ“– æ•…äº‹ç›®å½•</button>
        </div>

        <div id="story-list">
            <!-- JSç”Ÿæˆåˆ—è¡¨ -->
        </div>

        <div style="flex:1"></div> <!-- å ä½ -->

        <div class="story-text-box" id="caption">
            ç‚¹å‡»â€œæ’­æ”¾â€å¼€å§‹å¬æ•…äº‹å§...
        </div>

        <div class="controls">
            <button class="ctrl-btn" onclick="prevStory()">â®ï¸ ä¸Šä¸€ä¸ª</button>
            <button class="ctrl-btn" id="play-btn" onclick="togglePlay()">â–¶ï¸ æ’­æ”¾</button>
            <button class="ctrl-btn" onclick="nextStory()">ä¸‹ä¸€ä¸ª â­ï¸</button>
        </div>
    </div>

    <script>
        // ==============================
        // 1. æ•…äº‹æ•°æ® (30ä¸ªæ•…äº‹ï¼Œå¸¦åœºæ™¯é…ç½®)
        // ==============================
        const stories = [
            // --- æ£®æ—ç³»åˆ— ---
            { title: "å°å…”å­æ‰¾æœ‹å‹", icon: "ğŸ°", theme: "forest", text: "æ£®æ—é‡Œä½ç€ä¸€åªå°ç™½å…”ï¼Œå®ƒå¾ˆå­¤å•ã€‚æœ‰ä¸€å¤©ï¼Œå®ƒå‡ºé—¨å»æ‰¾æœ‹å‹ã€‚å®ƒé‡åˆ°äº†ä¸€åªå°æ¾é¼ ï¼Œæ¾é¼ ç»™äº†å®ƒä¸€é¢—æ¾æœã€‚å®ƒä»¬æˆä¸ºäº†å¥½æœ‹å‹ã€‚" },
            { title: "èªæ˜çš„ä¹Œé¸¦", icon: "ğŸ¦…", theme: "forest", text: "ä¸€åªä¹Œé¸¦å£æ¸´äº†ï¼Œåˆ°å¤„æ‰¾æ°´å–ã€‚å®ƒå‘ç°ä¸€ä¸ªç“¶å­ï¼Œä½†æ°´å¤ªå°‘å–ä¸åˆ°ã€‚ä¹Œé¸¦æŠŠå°çŸ³å­ä¸€é¢—é¢—ä¸¢è¿›ç“¶å­é‡Œï¼Œæ°´é¢å‡é«˜äº†ï¼Œä¹Œé¸¦å–åˆ°äº†æ°´ã€‚" },
            { title: "é¾Ÿå…”èµ›è·‘", icon: "ğŸ¢", theme: "forest", text: "å…”å­å˜²ç¬‘ä¹Œé¾Ÿçˆ¬å¾—æ…¢ï¼Œå®ƒä»¬å†³å®šæ¯”èµ›ã€‚å…”å­è·‘å¾—å¿«ï¼Œåœ¨åŠè·¯ç¡ç€äº†ã€‚ä¹Œé¾Ÿä¸åœåœ°çˆ¬ï¼Œæœ€åèµ¢å¾—äº†æ¯”èµ›ã€‚" },
            { title: "ç‹®å­å’Œè€é¼ ", icon: "ğŸ¦", theme: "forest", text: "å°è€é¼ åµé†’äº†ç‹®å­ï¼Œç‹®å­æ”¾äº†å®ƒã€‚åæ¥ç‹®å­è¢«ç½‘å›°ä½äº†ï¼Œå°è€é¼ å’¬ç ´äº†ç½‘ï¼Œæ•‘äº†ç‹®å­ã€‚" },
            { title: "å°ç†Šåƒèœ‚èœœ", icon: "ğŸ»", theme: "forest", text: "å°ç†Šæœ€çˆ±åƒèœ‚èœœã€‚å®ƒçˆ¬ä¸Šæ ‘ï¼Œèœœèœ‚å—¡å—¡å«ã€‚å°ç†Šè™½ç„¶è¢«å®äº†ä¸ªåŒ…ï¼Œä½†åƒåˆ°äº†ç”œç”œçš„èœ‚èœœï¼Œå¿ƒé‡Œç¾æ»‹æ»‹çš„ã€‚" },
            { title: "å¤§æ ‘çš„çƒ¦æ¼", icon: "ğŸŒ³", theme: "forest", text: "å¤§æ ‘è§‰å¾—è‡ªå·±å¤ªé«˜äº†ï¼Œæ²¡äººé™ªå®ƒç©ã€‚å°é¸Ÿé£æ¥äº†ï¼Œåœ¨å®ƒèº«ä¸Šç­‘å·¢å”±æ­Œã€‚å¤§æ ‘ä¸å†å­¤å•äº†ã€‚" },
            { title: "è˜‘è‡æˆ¿å­", icon: "ğŸ„", theme: "forest", text: "ä¸‹é›¨äº†ï¼Œå°èš‚èšèº²åœ¨è˜‘è‡ä¸‹ã€‚è´è¶ä¹Ÿæ¥äº†ï¼Œèœœèœ‚ä¹Ÿæ¥äº†ã€‚è˜‘è‡åƒä¸€æŠŠå¤§ä¼ï¼Œä¿æŠ¤äº†å¤§å®¶ã€‚" },
            { title: "è¤ç«è™«çš„ç¯", icon: "ğŸ’¡", theme: "night_forest", text: "æ™šä¸Šäº†ï¼Œæ£®æ—é»‘æ¼†æ¼†çš„ã€‚å°è¤ç«è™«ç‚¹äº®äº†å°ç¯ç¬¼ï¼Œä¸ºå¤§å®¶ç…§äº®å›å®¶çš„è·¯ã€‚" },

            // --- æµ·æ´‹ç³»åˆ— ---
            { title: "å°ä¸‘é±¼è¿·è·¯äº†", icon: "ğŸ ", theme: "ocean", text: "å¤§æµ·è“è“çš„ï¼Œå°ä¸‘é±¼æ¸¸å•Šæ¸¸ï¼Œæ‰¾ä¸åˆ°å¦ˆå¦ˆäº†ã€‚æµ·é¾Ÿçˆ·çˆ·å‘Šè¯‰å®ƒï¼Œæ²¿ç€çŠç‘šç¤æ¸¸å°±èƒ½å›å®¶ã€‚" },
            { title: "é²¸é±¼å–·æ°´", icon: "ğŸ³", theme: "ocean", text: "å¤§é²¸é±¼æµ®å‡ºæ°´é¢ï¼Œå–·å‡ºä¸€é“é«˜é«˜çš„æ°´æŸ±ã€‚å°é±¼ä»¬åœ¨æ°´æŸ±ä¸‹æ´—æ¾¡ï¼Œå¼€å¿ƒæäº†ã€‚" },
            { title: "æµ·æ˜Ÿè·³èˆ", icon: "â­", theme: "ocean", text: "æµ·åº•ä¸¾è¡Œèˆä¼šã€‚æµ·æ˜Ÿä¼¸å±•ç€äº”ä¸ªè§’ï¼Œåœ¨æ²™æ»©ä¸Šè½¬åœˆåœˆã€‚èƒèŸ¹æŒ¥åŠ¨é’³å­ä¸ºå®ƒä¼´å¥ã€‚" },
            { title: "ç« é±¼ç”»å®¶", icon: "ğŸ™", theme: "ocean", text: "ç« é±¼æœ‰å…«åªæ‰‹ï¼Œå®ƒåŒæ—¶æ‹¿å…«æ”¯ç”»ç¬”ã€‚ä¸€ä¼šå„¿å°±ç”»å‡ºäº†äº”é¢œå…­è‰²çš„æµ·åº•ä¸–ç•Œã€‚" },
            { title: "æ½œæ°´è‰‡æ¢é™©", icon: "ğŸ›¥ï¸", theme: "ocean", text: "é»„è‰²çš„æ½œæ°´è‰‡æ½œå…¥æ·±æµ·ã€‚å®ƒçœ‹åˆ°äº†å‘å…‰çš„æ°´æ¯ï¼Œè¿˜æœ‰å·¨å¤§çš„æ²‰èˆ¹å®è—ã€‚" },
            { title: "æµ·è±šæ•‘äºº", icon: "ğŸ¬", theme: "ocean", text: "å°èˆ¹ç¿»äº†ï¼Œæµ·è±šæ¸¸è¿‡æ¥ï¼ŒæŠŠè½æ°´çš„äººé¡¶å‡ºæ°´é¢ï¼Œé€åˆ°äº†å²¸è¾¹ã€‚æµ·è±šæ˜¯äººç±»çš„å¥½æœ‹å‹ã€‚" },
            { title: "è´å£³çš„ç§˜å¯†", icon: "ğŸš", theme: "ocean", text: "å°çº¢æ¡åˆ°ä¸€ä¸ªæµ·èºï¼Œæ”¾åœ¨è€³è¾¹å¬ã€‚å“‡ï¼Œé‡Œé¢æœ‰å¤§æµ·å‘¼å‘¼çš„å£°éŸ³ï¼Œé‚£æ˜¯å¤§æµ·åœ¨å”±æ­Œã€‚" },

            // --- å¤©ç©ºä¸å¤ªç©º ---
            { title: "æƒ³é£çš„ä¼é¹…", icon: "ğŸ§", theme: "snow", text: "ä¼é¹…æœ‰ç¿…è†€ä½†ä¸ä¼šé£ã€‚å®ƒçœ‹ç€æµ·é¸¥åœ¨é£ï¼Œå¾ˆç¾¡æ…•ã€‚åæ¥å®ƒè·³è¿›æ°´é‡Œï¼Œå‘ç°è‡ªå·±åœ¨æ°´é‡Œé£å¾—æ¯”è°éƒ½å¿«ã€‚" },
            { title: "æœˆäº®èˆ¹", icon: "ğŸŒ™", theme: "night_sky", text: "å¼¯å¼¯çš„æœˆäº®åƒå°èˆ¹ã€‚æ˜Ÿæ˜Ÿæ˜¯ä¹˜å®¢ã€‚äº‘æœµæ˜¯æµ·æµªã€‚æ¢¦é‡Œçš„å®å®åä¸Šæœˆäº®èˆ¹ï¼Œé£åˆ°äº†é“¶æ²³ç³»ã€‚" },
            { title: "å¤ªé˜³å…¬å…¬", icon: "â˜€ï¸", theme: "sky", text: "æ—©æ™¨ï¼Œå¤ªé˜³å…¬å…¬èµ·åºŠäº†ï¼Œå…¬é¸¡å–”å–”å«ã€‚å¤ªé˜³æŠŠå…‰æ´’åœ¨è‰åœ°ä¸Šï¼Œå°èŠ±éƒ½å¼€äº†ã€‚" },
            { title: "å½©è™¹æ¡¥", icon: "ğŸŒˆ", theme: "sky", text: "é›¨åœäº†ï¼Œå¤©ä¸Šå‡ºç°äº†ä¸€åº§ä¸ƒå½©çš„æ¡¥ã€‚å°ç™½å…”æƒ³çˆ¬ä¸Šå»ï¼Œçœ‹çœ‹äº‘æœµä¸Šé¢æœ‰ä»€ä¹ˆã€‚" },
            { title: "ç«ç®­å‡ç©º", icon: "ğŸš€", theme: "space", text: "3ï¼Œ2ï¼Œ1ï¼Œå‘å°„ï¼ç«ç®­å–·ç€ç«ï¼Œé£å‘å¤ªç©ºã€‚å®‡èˆªå‘˜å”å”åœ¨å¤ªç©ºé‡Œé£˜æ¥é£˜å»ï¼Œåƒè¶…äººä¸€æ ·ã€‚" },
            { title: "æ‘˜æ˜Ÿæ˜Ÿ", icon: "âœ¨", theme: "night_sky", text: "å°çŒ«æƒ³æ‘˜æ˜Ÿæ˜Ÿã€‚å®ƒçˆ¬ä¸Šæ¢¯å­ï¼Œè¿˜æ˜¯å¤Ÿä¸ç€ã€‚æ˜Ÿæ˜Ÿæ‰è¿›æ°´ç›†é‡Œï¼Œå°çŒ«å¼€å¿ƒåœ°ç¬‘äº†ã€‚" },
            { title: "å¤–æ˜Ÿäºº", icon: "ğŸ‘½", theme: "space", text: "é£ç¢Ÿé™è½åœ¨è‰åœ°ä¸Šï¼Œèµ°å‡ºä¸€ä¸ªç»¿è‰²çš„å°å¤–æ˜Ÿäººã€‚å®ƒé€ç»™å°æœ‹å‹ä¸€æœµå‘å…‰çš„èŠ±ã€‚" },

            // --- ç”Ÿæ´»ä¸å†œåœº ---
            { title: "å°çŒªç›–æˆ¿å­", icon: "ğŸ·", theme: "farm", text: "ä¸‰åªå°çŒªç›–æˆ¿å­ã€‚ç¨»è‰æˆ¿å€’äº†ï¼Œæœ¨å¤´æˆ¿å€’äº†ã€‚åªæœ‰ç –å¤´æˆ¿å­æœ€ç»“å®ï¼Œå¤§ç°ç‹¼å¹ä¸å€’ã€‚" },
            { title: "è´ªåƒçš„å°ç‹—", icon: "ğŸ¶", theme: "farm", text: "å°ç‹—çœ‹åˆ°æ°´é‡Œä¹Ÿæœ‰ä¸€å—è‚‰ï¼Œå®ƒæƒ³å»æŠ¢ï¼Œç»“æœå˜´é‡Œçš„è‚‰æ‰è¿›äº†æ²³é‡Œã€‚å®ƒä¼¤å¿ƒåœ°å“­äº†ã€‚" },
            { title: "å‹¤åŠ³çš„èœœèœ‚", icon: "ğŸ", theme: "farm", text: "æ˜¥å¤©æ¥äº†ï¼Œå°èœœèœ‚é£åˆ°èŠ±ä¸›ä¸­é‡‡èœœã€‚å®ƒå‘Šè¯‰è´è¶ï¼šåˆ«è´ªç©äº†ï¼Œå¿«æ¥å·¥ä½œå§ã€‚" },
            { title: "é›ªäººä¸è§äº†", icon: "â›„", theme: "snow", text: "å†¬å¤©å †çš„å¤§é›ªäººï¼Œæœ‰ç€çº¢é¼»å­ã€‚å¤ªé˜³å‡ºæ¥äº†ï¼Œé›ªäººæ…¢æ…¢å˜å°ï¼Œæœ€åå˜æˆäº†ä¸€æ»©æ°´ã€‚" },
            { title: "å‹‡æ•¢çš„æ¶ˆé˜²è½¦", icon: "ğŸš’", theme: "city", text: "å“ªé‡Œç€ç«äº†ï¼Œæ¶ˆé˜²è½¦å°±å‘œå‘œå‘œåœ°èµ¶è¿‡å»ã€‚æ°´æªå–·å‡ºå¤§æ°´ï¼ŒæŠŠç«æ‰‘ç­äº†ã€‚" },
            { title: "æ™šå®‰ï¼Œå°å®è´", icon: "ğŸ›Œ", theme: "night_room", text: "æœˆäº®ç¡ç€äº†ï¼Œå°é¸Ÿç¡ç€äº†ã€‚å®å®é—­ä¸Šçœ¼ç›ï¼Œå¬å¦ˆå¦ˆè®²æ•…äº‹ï¼Œåšä¸ªç”œç”œçš„æ¢¦ã€‚" },
            { title: "ç”Ÿæ—¥è›‹ç³•", icon: "ğŸ‚", theme: "room", text: "ä»Šå¤©æ˜¯å®å®çš„ç”Ÿæ—¥ã€‚ç‚¹ä¸Šèœ¡çƒ›ï¼Œè®¸ä¸ªæ„¿æœ›ã€‚å¤§å®¶ä¸€èµ·å”±ç”Ÿæ—¥æ­Œï¼Œç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼" },
            { title: "å¿«ä¹çš„æ ¡è½¦", icon: "ğŸšŒ", theme: "city", text: "é»„è‰²çš„æ ¡è½¦æ»´æ»´æ»´ã€‚æ¥ä¸Šå°é¸­ã€å°çŒ«å’Œå°çŒªï¼Œå¤§å®¶ä¸€èµ·å¼€å¼€å¿ƒå¿ƒå»ä¸Šå­¦ã€‚" }
        ];

        // ==============================
        // 2. Three.js åœºæ™¯å¼•æ“
        // ==============================
        let scene, camera, renderer;
        let actors = []; // å­˜æ”¾å½“å‰çš„ç‰©ä½“
        let particles; // ç²’å­ç³»ç»Ÿ
        let currentTheme = '';
        let frameId;

        function init3D() {
            const container = document.getElementById('canvas-container');

            // åœºæ™¯
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a1a2e, 10, 50); // é›¾æ•ˆå¢åŠ æ·±é‚ƒæ„Ÿ

            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // åœ°é¢ (ä¸€ä¸ªå·¨å¤§çš„åœ†ç›˜)
            const geometry = new THREE.CircleGeometry(20, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x228B22 }); // é»˜è®¤è‰åœ°ç»¿
            const ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.name = 'ground';
            scene.add(ground);

            animate();
            window.addEventListener('resize', onWindowResize, false);
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            frameId = requestAnimationFrame(animate);

            // æ‘„åƒæœºç¼“æ…¢æ—‹è½¬ï¼Œå¢åŠ åŠ¨æ€æ„Ÿ
            const time = Date.now() * 0.0005;
            camera.position.x = Math.sin(time) * 10;
            camera.position.z = Math.cos(time) * 10;
            camera.lookAt(0, 0, 0);

            // ç²’å­è¿åŠ¨
            if (particles) {
                particles.rotation.y += 0.002;
            }

            // è§’è‰²ç®€å•åŠ¨ç”» (æµ®åŠ¨/è·³è·ƒ)
            actors.forEach((actor, idx) => {
                actor.position.y = Math.sin(time * 2 + idx) * 0.5; // ä¸Šä¸‹æµ®åŠ¨
                actor.rotation.y += 0.01;
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==============================
        // 3. åœºæ™¯ç”Ÿæˆå™¨ (The Magic)
        // ==============================

        // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„â€œå·¥å‚â€ï¼Œæ ¹æ®ä¸»é¢˜æ”¹å˜ç¯å¢ƒ
        function setTheme(theme) {
            if (currentTheme === theme) return;
            currentTheme = theme;

            const ground = scene.getObjectByName('ground');

            // ç§»é™¤æ—§ç²’å­
            if (particles) {
                scene.remove(particles);
                particles = null;
            }

            // è®¾ç½®èƒŒæ™¯è‰²å’Œåœ°é¢è‰²
            let bgColor, groundColor, particleType;

            switch (theme) {
                case 'forest':
                    bgColor = 0x87CEEB; groundColor = 0x4CAF50; particleType = 'leaf';
                    break;
                case 'night_forest':
                    bgColor = 0x0f0f1a; groundColor = 0x1a2f1a; particleType = 'firefly';
                    break;
                case 'ocean':
                    bgColor = 0x1E90FF; groundColor = 0x000080; particleType = 'bubble';
                    break;
                case 'snow':
                    bgColor = 0xCFD8DC; groundColor = 0xffffff; particleType = 'snow';
                    break;
                case 'space':
                case 'night_sky':
                    bgColor = 0x000000; groundColor = 0x111111; particleType = 'star';
                    break;
                case 'farm':
                    bgColor = 0xFFECB3; groundColor = 0x8D6E63; particleType = 'cloud';
                    break;
                default:
                    bgColor = 0x87CEEB; groundColor = 0x90A4AE;
            }

            scene.background = new THREE.Color(bgColor);
            scene.fog.color.setHex(bgColor);
            ground.material.color.setHex(groundColor);

            createParticles(particleType);
        }

        // åˆ›å»ºç¯å¢ƒç²’å­
        function createParticles(type) {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const count = (type === 'star' || type === 'snow') ? 1000 : 200;

            for (let i = 0; i < count; i++) {
                const x = (Math.random() - 0.5) * 30;
                const y = (Math.random() - 0.5) * 30;
                const z = (Math.random() - 0.5) * 30;
                vertices.push(x, y, z);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            let color = 0xffffff;
            let size = 0.2;

            if (type === 'firefly') { color = 0xffff00; size = 0.15; }
            if (type === 'bubble') { color = 0x88ccff; size = 0.3; }
            if (type === 'leaf') { color = 0x4caf50; size = 0.2; }

            const material = new THREE.PointsMaterial({ color: color, size: size, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // ç®€å•çš„ç¨‹åºåŒ–å‡ ä½•ä½“ç”Ÿæˆ (ä»£æ›¿å¤æ‚æ¨¡å‹)
        function createActorShape(keyword) {
            const group = new THREE.Group();
            let mesh;

            // æ ¹æ®å…³é”®è¯ç”Ÿæˆç®€å•çš„ç»„åˆ
            // è¿™æ˜¯ä¸€ç§æŠ½è±¡è‰ºæœ¯ï¼šç”¨å‡ ä½•ä½“æš—ç¤ºç‰©ä½“
            if (keyword.includes('å…”') || keyword.includes('é›ªäºº')) {
                // ç™½è‰²çƒä½“ç»„åˆ
                const body = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshLambertMaterial({ color: 0xffffff }));
                const head = new THREE.Mesh(new THREE.SphereGeometry(0.6, 16, 16), new THREE.MeshLambertMaterial({ color: 0xffffff }));
                head.position.y = 1.2;
                group.add(body, head);
            } else if (keyword.includes('ç‹®') || keyword.includes('å¤ªé˜³') || keyword.includes('èŠ±')) {
                // é»„è‰²æ”¾å°„çŠ¶
                const core = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 16), new THREE.MeshLambertMaterial({ color: 0xFFD700 }));
                group.add(core);
            } else if (keyword.includes('é±¼') || keyword.includes('é²¸') || keyword.includes('æµ·')) {
                // è“è‰²æ¢­å½¢
                const body = new THREE.Mesh(new THREE.ConeGeometry(0.8, 2, 16), new THREE.MeshLambertMaterial({ color: 0x00BFFF }));
                body.rotation.z = Math.PI / 2;
                group.add(body);
            } else if (keyword.includes('æ ‘') || keyword.includes('è‰')) {
                // ç»¿è‰²åœ†é”¥
                const tree = new THREE.Mesh(new THREE.ConeGeometry(1, 3, 16), new THREE.MeshLambertMaterial({ color: 0x2E7D32 }));
                tree.position.y = 1.5;
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1), new THREE.MeshLambertMaterial({ color: 0x5D4037 }));
                group.add(tree, trunk);
            } else if (keyword.includes('æˆ¿å­') || keyword.includes('è½¦')) {
                // å½©è‰²ç«‹æ–¹ä½“
                const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff }));
                group.add(box);
            } else {
                // é»˜è®¤ï¼šéšæœºé¢œè‰²çš„å…«é¢ä½“
                mesh = new THREE.Mesh(new THREE.OctahedronGeometry(1), new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff }));
                group.add(mesh);
            }

            return group;
        }

        // æ›´æ–°åœºæ™¯ä¸­çš„ä¸»è§’
        function updateStage(story) {
            // æ¸…é™¤æ—§æ¼”å‘˜
            actors.forEach(a => scene.remove(a));
            actors = [];

            setTheme(story.theme);

            // æ ¹æ®æ•…äº‹æ ‡é¢˜çš„å…³é”®è¯ï¼Œç”Ÿæˆ 3-5 ä¸ªéšæœºä½ç½®çš„å‡ ä½•ä½“æ¼”å‘˜
            const count = 3 + Math.floor(Math.random() * 3);
            for (let i = 0; i < count; i++) {
                const actor = createActorShape(story.title + story.text); // æŠŠæ–‡æœ¬ä¼ è¿›å»ä½œä¸ºç§å­

                // éšæœºåˆ†å¸ƒåœ¨åœ†ç›˜ä¸Š
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 5;
                actor.position.set(Math.cos(angle) * radius, 0, Math.sin(angle) * radius);

                // ç¨å¾®æŠ¬é«˜ä¸€ç‚¹
                actor.position.y = 0.5;

                scene.add(actor);
                actors.push(actor);
            }
        }

        // ==============================
        // 4. é€»è¾‘ä¸æ§åˆ¶
        // ==============================
        let currentIndex = 0;
        let isPlaying = false;

        // è¯­éŸ³é…ç½® (å¤ç”¨ä¹‹å‰çš„å¼ºåŠ›é€»è¾‘)
        const synth = window.speechSynthesis;
        let preferredVoice = null;

        function loadVoices() {
            const allVoices = synth.getVoices();
            let mandarinVoices = allVoices.filter(v => v.lang.replace('_', '-').toLowerCase() === 'zh-cn');
            if (mandarinVoices.length === 0) mandarinVoices = allVoices.filter(v => v.lang.includes('zh'));
            preferredVoice = mandarinVoices.find(v => v.name.includes('Google') && v.name.includes('Chinese')) ||
                mandarinVoices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural')) ||
                mandarinVoices.find(v => v.name.includes('Ting-Ting')) ||
                mandarinVoices[0];
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        function speak(text, callback) {
            if (synth.speaking) synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            if (preferredVoice) u.voice = preferredVoice;
            u.rate = 0.9; u.pitch = 1;
            u.onend = () => { if (callback) callback(); };
            synth.speak(u);
        }

        function playStory(index) {
            if (index < 0) index = stories.length - 1;
            if (index >= stories.length) index = 0;
            currentIndex = index;

            const story = stories[index];

            // UI æ›´æ–°
            document.getElementById('caption').innerText = story.text;
            updateListUI();

            // 3D åœºæ™¯æ›´æ–°
            updateStage(story);

            // æ’­æ”¾
            isPlaying = true;
            document.getElementById('play-btn').innerText = "â¸ï¸ æš‚åœ";

            speak(story.title + "ã€‚" + story.text, () => {
                // è¯»å®Œåçš„å›è°ƒ
                isPlaying = false;
                document.getElementById('play-btn').innerText = "ğŸ”„ é‡æ’­";
                // è‡ªåŠ¨æŠŠâ€œä¸‹ä¸€ä¸ªâ€æŒ‰é’®é«˜äº®ä¸€ä¸‹æç¤º
                const nextBtn = document.querySelectorAll('.ctrl-btn')[2];
                nextBtn.style.transform = "scale(1.2)";
                setTimeout(() => nextBtn.style.transform = "scale(1)", 500);
            });
        }

        function togglePlay() {
            if (isPlaying) {
                synth.cancel();
                isPlaying = false;
                document.getElementById('play-btn').innerText = "â–¶ï¸ ç»§ç»­";
            } else {
                playStory(currentIndex);
            }
        }

        function nextStory() { playStory(currentIndex + 1); }
        function prevStory() { playStory(currentIndex - 1); }

        // åˆ—è¡¨ UI
        function initList() {
            const list = document.getElementById('story-list');
            stories.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'story-item';
                div.innerHTML = `<span style="font-size:1.5em">${s.icon}</span> <span>${s.title}</span>`;
                div.onclick = () => {
                    playStory(i);
                    toggleList(); // é€‰å®Œè‡ªåŠ¨æ”¶èµ·
                };
                list.appendChild(div);
            });
        }

        function updateListUI() {
            const items = document.querySelectorAll('.story-item');
            items.forEach((item, i) => {
                if (i === currentIndex) item.classList.add('active');
                else item.classList.remove('active');
            });
        }

        function toggleList() {
            document.getElementById('story-list').classList.toggle('open');
        }

        // å¯åŠ¨
        init3D();
        initList();

    </script>
</body>

</html>